# =============================================================================
# GitHub Actions: Scheduled Content Generation
# =============================================================================
# Automatically generates new blog content on a schedule.
# Uses the AI content generation pipeline with uniqueness checks.
# =============================================================================

name: Generate Blog Content

on:
  schedule:
    # Run every day at 9 AM UTC (adjust as needed)
    - cron: '0 9 * * *'

  workflow_dispatch:
    inputs:
      topic:
        description: 'Topic for the blog post'
        required: true
        type: string
      keyword:
        description: 'Target SEO keyword'
        required: true
        type: string
      intent:
        description: 'Search intent type'
        required: false
        default: 'informational'
        type: choice
        options:
          - informational
          - transactional
          - commercial
          - navigational
      auto_publish:
        description: 'Auto-publish (skip review)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  generate:
    name: Generate Content
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine content topic
        id: topic
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "topic=${{ inputs.topic }}" >> $GITHUB_OUTPUT
            echo "keyword=${{ inputs.keyword }}" >> $GITHUB_OUTPUT
            echo "intent=${{ inputs.intent }}" >> $GITHUB_OUTPUT
            echo "publish=${{ inputs.auto_publish }}" >> $GITHUB_OUTPUT
          else
            # For scheduled runs, use content calendar or random selection
            # This is a placeholder - integrate with your content calendar
            echo "topic=AI Automation Best Practices" >> $GITHUB_OUTPUT
            echo "keyword=ai automation best practices" >> $GITHUB_OUTPUT
            echo "intent=informational" >> $GITHUB_OUTPUT
            echo "publish=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate content
        run: |
          npm run generate -- \
            --topic "${{ steps.topic.outputs.topic }}" \
            --keyword "${{ steps.topic.outputs.keyword }}" \
            --intent "${{ steps.topic.outputs.intent }}" \
            --publish "${{ steps.topic.outputs.publish }}"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Validate generated content
        run: npm run validate:content

      - name: Commit new content
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Check if there are changes to commit
          if [ -n "$(git status --porcelain content/)" ]; then
            git add content/
            git add knowledge-base/

            TOPIC="${{ steps.topic.outputs.topic }}"
            git commit -m "Add blog post: ${TOPIC:0:50}

            Generated by programmatic SEO pipeline
            Keyword: ${{ steps.topic.outputs.keyword }}
            Intent: ${{ steps.topic.outputs.intent }}

            Generated with Claude AI"

            git push
          else
            echo "No new content generated"
          fi

      - name: Create PR for review (if not auto-publishing)
        if: success() && steps.topic.outputs.publish != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add blog post: ${{ steps.topic.outputs.topic }}"
          title: "[Content Review] ${{ steps.topic.outputs.topic }}"
          body: |
            ## New Blog Post Generated

            **Topic**: ${{ steps.topic.outputs.topic }}
            **Keyword**: ${{ steps.topic.outputs.keyword }}
            **Intent**: ${{ steps.topic.outputs.intent }}

            ### Review Checklist
            - [ ] Content is factually accurate
            - [ ] Unique value proposition is clear
            - [ ] No duplicate content concerns
            - [ ] SEO metadata is optimized
            - [ ] Internal links are appropriate

            Generated by the programmatic SEO pipeline.
          branch: content/new-post-${{ github.run_number }}
          delete-branch: true
          labels: |
            content-review
            auto-generated
