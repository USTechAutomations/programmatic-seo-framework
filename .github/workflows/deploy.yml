# =============================================================================
# GitHub Actions: Programmatic SEO Blog Deployment
# =============================================================================
# This workflow:
# 1. Validates all content for quality and uniqueness
# 2. Builds the Next.js site with static generation
# 3. Deploys to production
# 4. Updates metrics and logs
# =============================================================================

name: Deploy Programmatic SEO Blog

on:
  push:
    branches:
      - main
    paths:
      - 'content/blog/**'
      - 'src/**'
      - 'package.json'
      - 'next.config.js'

  workflow_dispatch:
    inputs:
      skip_validation:
        description: 'Skip content validation'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  NEXT_PUBLIC_SITE_URL: ${{ vars.SITE_URL || 'https://www.ustechautomations.com' }}

jobs:
  # ---------------------------------------------------------------------------
  # Validate Content Quality
  # ---------------------------------------------------------------------------
  validate:
    name: Validate Content
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_validation != 'true' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Get previous commit for diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'content/blog/*.md' | tr '\n' ' ')
            echo "files=$CHANGED" >> $GITHUB_OUTPUT
          else
            echo "files=" >> $GITHUB_OUTPUT
          fi

      - name: Validate content
        run: |
          if [ -n "${{ steps.changed-files.outputs.files }}" ]; then
            for file in ${{ steps.changed-files.outputs.files }}; do
              echo "Validating: $file"
              npm run validate:content -- "$file"
            done
          else
            echo "Validating all content..."
            npm run validate:content
          fi

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-report
          path: knowledge-base/metrics/validation-log.json
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Build and Deploy
  # ---------------------------------------------------------------------------
  build-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js site
        run: npm run build
        env:
          NEXT_PUBLIC_SITE_URL: ${{ env.NEXT_PUBLIC_SITE_URL }}

      - name: Export static files (if configured)
        run: |
          if grep -q '"output": "export"' next.config.js 2>/dev/null; then
            echo "Static export configured"
          fi

      # ---------------------------------------------------------
      # OPTION A: Deploy to Vercel (Recommended for Next.js)
      # ---------------------------------------------------------
      - name: Deploy to Vercel
        if: ${{ vars.DEPLOY_TARGET == 'vercel' || vars.DEPLOY_TARGET == '' }}
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

      # ---------------------------------------------------------
      # OPTION B: Deploy to Netlify
      # ---------------------------------------------------------
      - name: Deploy to Netlify
        if: ${{ vars.DEPLOY_TARGET == 'netlify' }}
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './.next'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # ---------------------------------------------------------
      # OPTION C: Deploy to AWS S3/CloudFront
      # ---------------------------------------------------------
      - name: Configure AWS credentials
        if: ${{ vars.DEPLOY_TARGET == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Deploy to S3
        if: ${{ vars.DEPLOY_TARGET == 'aws' }}
        run: |
          aws s3 sync ./out s3://${{ secrets.S3_BUCKET }} --delete

      - name: Invalidate CloudFront
        if: ${{ vars.DEPLOY_TARGET == 'aws' }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

  # ---------------------------------------------------------------------------
  # Post-Deployment Tasks
  # ---------------------------------------------------------------------------
  post-deploy:
    name: Post-Deployment
    runs-on: ubuntu-latest
    needs: [build-deploy]
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update deployment metrics
        run: |
          echo "Deployment completed at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: Ping search engines
        run: |
          # Ping Google
          curl -s "https://www.google.com/ping?sitemap=${{ env.NEXT_PUBLIC_SITE_URL }}/sitemap.xml" || true

          # Ping Bing
          curl -s "https://www.bing.com/ping?sitemap=${{ env.NEXT_PUBLIC_SITE_URL }}/sitemap.xml" || true

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ env.NEXT_PUBLIC_SITE_URL }}" >> $GITHUB_STEP_SUMMARY
